# 实验报告

### 实验目标

1. 实现一个基于一致性哈希分区算法的分布式键值 (Key-Value) 数据存储系统。
2. 系统要提供一个客户端SDK，该SDK支持两类操作:
   1. put(key value): 写入一个键值对，key是定长字符串; value是长度受限的变长字符串,
   2. get(key): 返回指定key对应的value。如果不存在，则返回null。
3. 在客户端SDK中:以key为输入，利用一致性哈希算法计算出负责存储该key的节点标识，然后将put或get操作发送给该节点
4. 不同节点可以在单机上用不同的进程 (在不同的端口号监听)或虚拟机模拟;
5. 将服务器节点标识列表作为客户端SDK的初始化参数。
6. 建值数据保存在内存中就可以。
7. 支持增删节点。

### 实验思路

1. 数据以键值对的形式存储，所以将数据结构设定为 `Map` 表最合适，同时为了方便进行数据的 `put`,`get` 操作，将数据结构定为 `TreeMap`，可以自动将表内节点按照 `key` 值的升序排列，方便后续寻找节点。
2. 哈希算法的实现可以直接调用 Java 自带的库函数 `hashCode()`，但是得到的结果位数太大，而且对于相似的数据得到的哈希值仍然很接近，不满足实验要求的平均随机分布，所以想到用 MD5 算法计算给定数据的哈希值，然后从生成的32位数据中截取中间的十位数作为输入用 `hashCode()` 计算出哈希值，然后截取末尾的五位数字作为最终的哈希值输出，这样进行了三次哈希值的计算，大致上可以保证结果的随机性。假定数据 `key` 为定长的7位字符串。
3. 分布式的模拟采用的是在本机上用不同的进程模拟节点的方式，每个进程用端口号进行区分。整个分布式系统分为 `client`,`DataNode `两个部分，`client` 负责与用户交互，与 `NameNode` 通信，传入读取数据和利用一致性哈希算法分配数据。`DataNode` 负责存储数据。两者之间的数据传输通过 `socket` 来进行。
4. `client` 中实现一个 `DataNode` 的代理类 `NodeProxy`，在其中存放节点的端口号、socket 对象以及读写流。将传递给 `DataNode` 进行数据操作的指令包装暴露为方法，规定数据包格式为`put|get key (data)`。端口号计算得到的哈希值作键，对应代理节点 `NodeProxy` 作值，一同放入 `TreeMap<Integer, NodeProxy>` 中实现对节点的管理。
5. 一致性哈希算法的实现关键在于节点的寻找。本实验中采用的方法是在方法 `locateNode` 中包装`TreeMap.ceilingKey()` 方法，传入字符串作为 `key`，找出哈希环上位于 `hash(key)`以后的 DataNode 节点。
6. 另一关键点在于增加删除节点时的数据迁移问题，一致性哈希算法的特点在于每次节点改变只会影响其下一节点。因此只需在 `locateNode` 方法实现后，读取需要迁移的数据并转发即可。此处需要注意不能删除全部节点。

### 运行

1. 编译

   ``` powershell
   mvn clean
   mvn compile
   ```

2. 在 `target/classes` 目录下，启动 DataNode 节点并监听 4001 端口

   ``` powershell
   java DataNode 4001
   ```

   如果没有指定端口会打印提示

   启动 Client

   ```  java
   java Client 4001
   ```

   如果没有指定端口会打印提示

3. 存入并读取数据

   ![image-20230619103307507](README.assets/image-20230619103307507.png)

4. 启动 DataNode 节点并监听 4000 端口

   ``` powershell
   java DataNode 4000
   ```

   Client 加入 4000 端口的 DataNode

   ``` powershell
   > add 4000
   ```

   此时会发生数据迁移

   同时检查系统的读写功能正常

   ![image-20230619103410834](README.assets/image-20230619103410834.png)

5. 移除 4000 端口的 DataNode

   ``` powershell
   > remove 4000
   ```

   此时会发生数据迁移，并关闭 DataNode@4000

   ![image-20230619103443754](README.assets/image-20230619103443754.png)